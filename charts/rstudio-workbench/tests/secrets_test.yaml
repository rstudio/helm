suite: Workbench Secrets
templates:
  - configmap-general.yaml
  - configmap-prestart.yaml
  - configmap-secret.yaml
  - configmap-session.yaml
  - deployment.yaml
tests:
  - it: should set userPassword from existing secret
    template: deployment.yaml
    set:
      userCreate: true
      userPassword:
        existingSecret: "userpassword-secret"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_PASSWD")].valueFrom.secretKeyRef.name'
          value: userpassword-secret
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_PASSWD")].valueFrom.secretKeyRef.key'
          value: password
  - it: should set userPassword from literal value
    template: deployment.yaml
    set:
      userCreate: true
      userPassword:
        value: "myplaintextpassword"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_PASSWD")].value'
          value: "myplaintextpassword"
  - it: should not set the env var RSW_TESTUSER_PASSWD if neither userPasswrd.existingSecret nor userPassword.value is set
    template: deployment.yaml
    set:
      userCreate: true
    asserts:
      - equal:
        path: 'spec.template.spec.containers[0].env[?(@.name=="RSW_TESTUSER_PASSWD")]'
        value: null
        not: true
  - it: should specify a volumeMount and a projected volume for rstudio-secret if config.secret is set
    template: deployment.yaml
    set:
      config:
        defaultMode:
          secret: 0600
        secret:
          database.conf:
            provider: 'postgresql'
            database: 'rsp'
            port: 5432
            host: 'db.example.com'
            username: 'rstudio_app'
            password: 'securepassword'
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].mountPath'
          value: "/mnt/secret-configmap/rstudio/"
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.name'
          value: 'database.conf'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].key'
          value: 'database.conf'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].mode'
          value: 0600
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].path'
          value: 'database.conf'
      - matchRegex:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].value'
          pattern: '.*provider:postgresql.*'
      - matchRegex:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].value'
          pattern: '.*password:securepassword.*'
  - it: should specify a volumeMount and a projected volume for rstudio-secret if launcherPem.existingSecret is set
    template: deployment.yaml
    set:
      config:
        defaultMode:
          secret: 0600
      launcherPem:
        existingSecret: "launcherpem-secret"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].mountPath'
          value: "/mnt/secret-configmap/rstudio/"
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.name'
          value: 'launcher-pem-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].key'
          value: 'launcherpem-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].mode'
          value: 0600
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].path'
          value: 'launcher.pem'
  - it: should specify a volumeMount and a projected volume for rstudio-secret based on secureCookieKey.existingSecret if secureCookieKey.existingSecret is set and global.secureCookieKey.existingSecret is not set
    template: deployment.yaml
    set:
      config:
        defaultMode:
          secret: 0600
      secureCookieKey:
        existingSecret: "securecookiekey-secret"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].mountPath'
          value: "/mnt/secret-configmap/rstudio/"
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.name'
          value: 'secure-cookie-key-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].key'
          value: 'securecookiekey-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].mode'
          value: 0600
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].path'
          value: 'secure-cookie-key'
  - it: should specify a volumeMount and a projected volume for rstudio-secret based on global.secureCookieKey.existingSecret if secureCookieKey.existingSecret is set and global.secureCookieKey.existingSecret is set
    template: deployment.yaml
    set:
      config:
        defaultMode:
          secret: 0600
      global:
        secureCookieKey:
            existingSecret: "globalsecurecookiekey-secret"
      secureCookieKey:
        existingSecret: "securecookiekey-secret"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].mountPath'
          value: "/mnt/secret-configmap/rstudio/"
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.name'
          value: 'global-secure-cookie-key-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].key'
          value: 'globalsecurecookiekey-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].mode'
          value: 0600
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].path'
          value: 'secure-cookie-key'
  - it: should specify a volumeMount and a projected volume for rstudio-secret based on global.secureCookieKey.existingSecret if secureCookieKey.existingSecret is not set and global.secureCookieKey.existingSecret is set
    template: deployment.yaml
    set:
      config:
        defaultMode:
          secret: 0600
      global:
        secureCookieKey:
          existingSecret: "globalsecurecookiekey-secret"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].mountPath'
          value: "/mnt/secret-configmap/rstudio/"
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.name'
          value: 'global-secure-cookie-key-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].key'
          value: 'globalsecurecookiekey-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].mode'
          value: 0600
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].path'
          value: 'secure-cookie-key'
  - it: should specify a volumeMount and a projected volume for rstudio-secret if config.database.conf.existingSecret is set
    template: deployment.yaml
    set:
      config:
        defaultMode:
          secret: 0600
        database:
          conf:
            existingSecret: "databaseconf-secret"
    asserts:
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].mountPath'
          value: "/mnt/secret-configmap/rstudio/"
      - equal:
          path: 'spec.template.spec.containers[0].volumeMounts[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].name'
          value: "rstudio-secret"
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.name'
          value: 'database-conf-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].key'
          value: 'databaseconf-secret'
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].mode'
          value: 0600
      - equal:
          path: 'spec.template.spec.volumes[?(@.name=="rstudio-secret")].projected.sources[0].secret.items[0].path'
          value: 'database.conf'
